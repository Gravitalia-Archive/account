---
import Layout from "../layouts/Layout.astro";
import { t } from "../../Translator";
import Sidebar from "../components/Sidebar.astro";

const locale = `; ${Astro.request.headers.get("cookie")}`?.split(`; locale=`)[1]?.split(";")[0] ||
Astro.request.headers.get("accept-language")?.split(",")[0]?.split("-")[0] ||
"en";
const cookie = `; ${Astro.request.headers.get("cookie")}`?.split(`; session=`)[1]?.split(";")[0];
let user;
if(cookie) {
    user = await fetch("https://oauth.gravitalia.com/users/@me", {
		headers: {
			"Authorization": cookie
		}
	})
	.then(res => res.json())
	.catch(_ => null)
	.then(res => res);
	
	if(user?.message) return Astro.redirect("/signin", 307);
} else {
	return Astro.redirect("/signin", 307);
}
---

<Layout title="My Account - Gravitalia Account" absolute={null}>
	<main class="min-h-screen w-full text-gray-700 dark:text-white">
		<header class="flex w-full items-center justify-between bg-white dark:bg-zinc-800 p-2">
			<div class="flex items-center space-x-2">
				<img src="/favicon.webp" class="h-8 w-8" />
				<h1 class="pl-2 text-xl font-bold">Gravitalia</h1>
			</div>

			<div class="relative pr-10 pt-2">
				<button aria-label="User menu" class="flex rounded-full text-sm focus:outline-none" onclick="document.getElementById('show-profile').classList.value.includes('hidden')?document.getElementById('show-profile').classList.remove('hidden'):document.getElementById('show-profile').classList.add('hidden')">
					<img src={user.avatar ? `https://cdn.gravitalia.com/${user.avatar}` : `https://www.gravitalia.com/avatar/${user.username[0].match(/[A-z]/) ? user.username[0].toUpperCase() : "A"}.webp`} class="h-8 w-8 rounded-full" alt="" />
				</button>

				<div class="pt-1">
					<div id="show-profile" class="hidden z-50 origin-top-right absolute right-5 mt-2 w-48 rounded-md shadow-lg py-1 bg-slate-100 dark:bg-slate-900 ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="vertical">
						<svg class="absolute bottom-full right-4" width="22" height="13" viewBox="0 0 30 20" xmlns="http://www.w3.org/2000/svg">
							<polygon class="fill-slate-100 dark:fill-slate-900" points="15, 0 30, 20 0, 20"/>
						</svg>
						<p class="block px-4 py-2 text-sm text-gray-800 dark:text-gray-100">{t("Signed in as", locale)}<br /><strong>{ user.username }</strong></p>
						<hr />
						<div class="grid grid-cols-3 px-6 py-3">
							<a href="https://www.gravitalia.com/" class="hover:bg-gray-200 w-10 h-10 rounded-full flex justify-center items-center"><img alt="Gravitalia" src="/favicon.webp" class="w-7 h-7" draggable="false" /></a>
						</div>
						<hr />
						<span class="block px-4 py-2 text-sm text-gray-700 dark:text-white cursor-pointer"><span onclick="document.cookie = 'session=gv;expires=Thu, 01 Jan 1970 00:00:01 GMT;',window.location.reload();">{t("Logout", locale)}</span></span>
					</div>
				</div>
			</div>
		</header>
	
		<div class="flex">
			<Sidebar />
	
			<div class="w-full p-4">
				<p class="text-2xl font-semibold pb-4">{t("Your public profile", locale)}</p>
				<div class="pt-4 pl-4 pr-4 border dark:border-none dark:bg-zinc-800 shadow-xs w-full md:w-4/5 lg:w-1/2 h-64 lg:h-96 rounded-md">
					<div class="space-y-4">
						<div class="flex justify-center">
							<input type="file" accept="image/*" id="avatar_input" class="hidden" />
							<div onclick="avatar_picker()" class="flex -space-x-32 cursor-pointer">
								<img id="avatar" onmouseenter="document.getElementById('avatar_hover').classList.remove('hidden')" class="rounded-full w-32 h-32" src= {user.avatar ? `https://cdn.gravitalia.com/${user.avatar}` : `https://www.gravitalia.com/avatar/${user.username[0].match(/[A-z]/) ? user.username[0].toUpperCase() : "A"}.webp`} alt="" />
								<div id="avatar_hover" onmouseleave="document.getElementById('avatar_hover').classList.add('hidden')" class="hidden w-32 h-32 bg-zinc-700/60 rounded-full inset-0 flex justify-center items-center text-white">
									<p class="pl-2 text-white font-bold text-sm z-40 mix-blend-normal">Upload image</p>
								</div>
							</div>
							<span class="pl-14 absolute">
								<span class="w-6 h-6 bg-gray-200 absolute rounded-full flex justify-center items-center">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
										<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
									</svg>
								</span>
							</span>
						</div>
						<div class="flex items-center justify-center">
							<p onclick="open_modal()" id="username" class="pl-6 cursor-pointer rounded-sm max-w-4 text-xl font-semibold">{user.username}</p>
							<div class="pl-2" onclick="open_modal()">
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="cursor-pointer w-5 h-5">
									<path d="M21.731 2.269a2.625 2.625 0 00-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 000-3.712zM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 00-1.32 2.214l-.8 2.685a.75.75 0 00.933.933l2.685-.8a5.25 5.25 0 002.214-1.32L19.513 8.2z" />
								</svg>
							</div>
						</div>
					</div>
					<div class="pt-4 lg:pt-32"><button onclick="save()" class="mt-auto h-full w-full py-2 bg-green-500 hover:bg-green-700 transition-colors duration-300 text-white rounded-md">{t("Save", locale)}</button></div>
				</div>
			</div>

			<div id="name_modal" class="hidden fixed w-full h-100 inset-0 z-50 overflow-hidden flex justify-center items-center" style="background: rgba(0,0,0,.7);">
				<div class="border-none shadow-lg bg-white dark:bg-zinc-900 w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
					<div class="py-4 text-left px-6">
						<div class="flex justify-between items-center">
							<p class="text-2xl font-bold">{t("Update username", locale)}</p>
							<div class="cursor-pointer z-50" onclick="close_modal()">
								<svg class="fill-current text-black dark:text-white" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
									viewBox="0 0 18 18">
									<path
										d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z">
									</path>
								</svg>
							</div>
						</div>
						<p class="pb-3 text-sm text-gray-500 dark:text-gray-400">{t("Update your username will affect every services.", locale)}</p>
						<div class="my-5">
							<label for="new_username" id="invalid_username_label" class="hidden text-sm text-red-500 w-full">{t("Invalid username", locale)}</label>
							<input id="new_username" class="focus:outline-none text-lg border dark:border-zinc-800 dark:bg-zinc-800 w-full py-2 px-2 rounded-md" placeholder={user.username} value={user.username} maxlength="25" minlength="1" />
						</div>
						<div class="flex justify-end pt-2">
							<button onclick="close_modal()" class="focus:outline-none px-4 bg-none hover:underline duration-300 p-3 rounded-lg text-black hover:bg-gray-300 dark:text-white hover:dark:text-gray-200 hover:dark:bg-gray-800">{t("Cancel", locale)}</button>
							<button onclick="confirm_change_username()" class="focus:outline-none px-4 ml-3 rounded-lg text-white bg-green-500 hover:bg-green-700 transition-colors duration-300">{t("Confirm", locale)}</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</main>
</Layout>

<script lang="js">
	function avatar_picker() {
		const fileInput = document.getElementById('avatar_input');
		fileInput.click();

		fileInput.addEventListener('change', (event) => {
			const selectedFiles = event.target.files;
			if (selectedFiles && selectedFiles.length > 0) {
				const file = selectedFiles[0];
				if (file.type.startsWith('image/')) {
					const reader = new FileReader();

					reader.onload = async (event) => {
						document.getElementById("avatar").src = event.target.result;
					};

					reader.readAsDataURL(file);
				}
			}
		});
	}

	function close_modal() {
		document.getElementById("name_modal").classList.add("hidden");
	}
	function open_modal() {
		document.getElementById("name_modal").classList.remove("hidden");
	}
	function confirm_change_username() {
		if(document.getElementById("new_username").value.length > 25) {
			document.getElementById("new_username").classList.remove("dark:border-zinc-800");
			document.getElementById("new_username").classList.add("border-red-500", "dark:border-red-600");
			document.getElementById("invalid_username_label").classList.remove("hidden");
		} else {
			document.getElementById("new_username").classList.add("dark:border-zinc-800");
			document.getElementById("new_username").classList.remove("border-red-500");
			document.getElementById("invalid_username_label").classList.add("hidden");
			document.getElementById("username").innerText = document.getElementById("new_username").value;

			const avatar = document.getElementById("avatar").src;
			if(avatar.match(/https:\/\/www[.]gravitalia[.]com\/avatar\/[A-Z]{1}[.]webp/g).length !== 0) {
				document.getElementById("avatar").src = `https://www.gravitalia.com/avatar/${document.getElementById("username").innerHTML[0].match(/[A-z]/) ? document.getElementById("username").innerHTML[0].toUpperCase() : "A"}.webp`
			}

			document.getElementById("name_modal").classList.add("hidden");
		}
	}

	async function save() {
		fetch("https://oauth.gravitalia.com/users/@me", {
			method: "PATCH",
			headers: {
				"Authorization": `; ${document.cookie}`?.split(`; session=`)[1]?.split(";")[0],
				"Content-Type": "application/json"
			},
			body: JSON.stringify({
				username: document.getElementById("username").innerText,
				avatar: document.getElementById("avatar").src.includes("data:image/") ? Array.from(new Uint8Array(await (await fetch(document.getElementById("avatar").src)).arrayBuffer())) : null
			})
		}).then(res => res.json())
		.then(res => {
			if(!res.error) {
				window.location.reload();
			} else if(res.message === "Invalid username") {
				open_modal();
				document.getElementById("new_username").classList.remove("dark:border-zinc-800");
				document.getElementById("new_username").classList.add("border-red-500", "dark:border-red-600");
				document.getElementById("invalid_username_label").classList.remove("hidden");
			}
		});
	}
</script>