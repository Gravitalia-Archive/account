---
import Layout from "../layouts/Layout.astro";
import { t } from "../../Translator";
import Sidebar from "../components/Sidebar.astro";

const locale = `; ${Astro.request.headers.get("cookie")}`?.split(`; locale=`)[1]?.split(";")[0] ||
Astro.request.headers.get("accept-language")?.split(",")[0]?.split("-")[0] ||
"en";
const cookie = `; ${Astro.request.headers.get("cookie")}`?.split(`; session=`)[1]?.split(";")[0];
let user;
if(cookie) {
    user = await fetch("https://oauth.gravitalia.com/users/@me", {
		headers: {
			"Authorization": cookie
		}
	})
	.then(res => res.json())
	.catch(_ => null)
	.then(res => res);
	
	if(user?.message) return Astro.redirect("/signin", 307);
} else {
	return Astro.redirect("/signin", 307);
}
---

<Layout title="My Account - Gravitalia Account" absolute={null}>
	<main class="min-h-screen w-full text-gray-700 dark:text-white">
		<header class="flex w-full items-center justify-between bg-white dark:bg-zinc-800 p-2">
			<div class="flex items-center space-x-2">
				<img src="/favicon.webp" class="h-8 w-8" />
				<h1 class="pl-2 text-xl font-bold">Gravitalia</h1>
			</div>

			<div class="relative pr-10 pt-2">
				<button aria-label="User menu" class="flex rounded-full text-sm focus:outline-none" onclick="document.getElementById('show-profile').classList.value.includes('hidden')?document.getElementById('show-profile').classList.remove('hidden'):document.getElementById('show-profile').classList.add('hidden')">
					<img src={user.avatar ? import.meta.env.CDN_URL+"/t_avatar/"+user.avatar+".webp" : `https://www.gravitalia.com/avatar/${user.username[0].match(/[A-z]/) ? user.username[0].toUpperCase() : "A"}.webp`} class="h-8 w-8 rounded-full" alt="" />
				</button>

				<div class="pt-1">
					<div id="show-profile" class="hidden z-50 origin-top-right absolute right-5 mt-2 w-48 rounded-md shadow-lg py-1 bg-slate-100 dark:bg-slate-900 ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="vertical">
						<svg class="absolute bottom-full right-4" width="22" height="13" viewBox="0 0 30 20" xmlns="http://www.w3.org/2000/svg">
							<polygon class="fill-slate-100 dark:fill-slate-900" points="15, 0 30, 20 0, 20"/>
						</svg>
						<p class="block px-4 py-2 text-sm text-gray-800 dark:text-gray-100">{t("Signed in as", locale)}<br /><strong>{ user.username }</strong></p>
						<hr />
						<div class="grid grid-cols-3 px-6 py-3">
							<a href="https://www.gravitalia.com/" class="hover:bg-gray-200 w-10 h-10 rounded-full flex justify-center items-center"><img alt="Gravitalia" src="/favicon.webp" class="w-7 h-7" draggable="false" /></a>
						</div>
						<hr />
						<span class="block px-4 py-2 text-sm text-gray-700 dark:text-white cursor-pointer"><span onclick="document.cookie = 'session=gv;expires=Thu, 01 Jan 1970 00:00:01 GMT;',window.location.reload();">{t("Logout", locale)}</span></span>
					</div>
				</div>
			</div>
		</header>
	
		<div class="flex">
            <Sidebar />
            
			<div class="w-full p-4">
				<p class="text-2xl font-semibold pb-4">{t("Update personal data", locale)}</p>
				<div class="border dark:border-none dark:bg-zinc-800 shadow-xs w-full lg:w-2/5 h-min rounded-md">
                    <p onclick="open_modal('email')" class="px-4 py-3 flex items-center justify-between hover:bg-gray-100 cursor-pointer"><span class="text-gray-500 text-sm">{t("Email", locale)}</span> <span class="text-md">{t("Update your email address", locale)}</span> <span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></span></p>
                    <hr />
                    <p onclick="open_modal('birth')" class="px-4 py-3 flex items-center justify-between hover:bg-gray-100 cursor-pointer"><span class="text-gray-500 text-sm">{t("Birthday", locale)}</span> <span class="text-md">{t("Not set", locale)}</span> <span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></span></p>
					<hr />
                    <!-- <p onclick="open_modal('phone')" class="px-4 py-3 flex items-center justify-between hover:bg-gray-100 cursor-pointer"><span class="text-gray-500 text-sm">{t("Phone", locale)}</span> <span class="text-md">{t("Not set", locale)}</span> <span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></span></p>
                    <hr /> -->
                    <p onclick="open_modal('password')" class="px-4 py-3 flex items-center justify-between hover:bg-gray-100 cursor-pointer"><span class="text-gray-500 text-sm">{t("Password", locale)}</span> <span class="text-md">••••••••••••••</span> <span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></span></p>
				</div>
			</div>

			<div id="name_modal" class="hidden fixed w-full h-100 inset-0 z-50 overflow-hidden flex justify-center items-center" style="background: rgba(0,0,0,.7);">
				<div class="border-none shadow-lg bg-white dark:bg-zinc-900 w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
					<div class="py-4 text-left px-6">
						<div class="flex justify-between items-center">
							<p id="uemail" class="hidden text-2xl font-bold">{t("Update email", locale)}</p>
                            <p id="ubirth" class="hidden text-2xl font-bold">{t("Update birthdate", locale)}</p>
                            <p id="upass" class="hidden text-2xl font-bold">{t("Update password", locale)}</p>
							<div class="cursor-pointer z-50" onclick="close_modal()">
								<svg class="fill-current text-black dark:text-white" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
									viewBox="0 0 18 18">
									<path
										d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z">
									</path>
								</svg>
							</div>
						</div>
						<p class="pb-3 text-sm text-gray-500 dark:text-gray-400">
                            <span class="hidden" id="password-tips">{t("At least 8 characters with numbers and symbols", locale)}</span>
                            <span class="hidden" id="birth-tips">{t("You must have at least 13 years old.", locale)}</span>
                        </p>
						<label id="already_used_email" for="email" class="hidden text-sm w-full text-red-500">{t("The email address entered is already in use.", locale)}</label>
						<label id="invalid_password" for="actualpassword" class="hidden text-sm w-full text-red-500">{t("Invalid password", locale)}</label>

						<div id="emailshow" class="my-5 hidden">
							<label for="email" class="text-sm w-full">{t("Email adress", locale)}</label>
							<input type="email" id="email" class="focus:outline-none text-lg border dark:border-zinc-800 dark:bg-zinc-800 w-full py-2 px-2 rounded-md" placeholder={t("Email adress", locale)} required />
						</div>
                        <div id="birthshow" class="my-5 hidden">
							<label for="birthdate" class="text-sm w-full">{t("Birthdate", locale)}</label>
							<input type="date" id="birthdate" class="focus:outline-none text-lg border dark:border-zinc-800 dark:bg-zinc-800 w-full py-2 px-2 rounded-md" placeholder={t("Birthdate", locale)} max="2023" min="1920" />
						</div>
                        <div id="newpassshow" class="my-5 hidden">
							<label for="password" class="text-sm w-full">{t("New password", locale)}</label>
							<input type="password" id="password" class="focus:outline-none text-lg border dark:border-zinc-800 dark:bg-zinc-800 w-full py-2 px-2 rounded-md" placeholder={t("New password", locale)} required />
						</div>
                        <div id="passshow" class="my-6 hidden">
							<label for="actualpassword" class="text-sm w-full">{t("Actual password", locale)}</label>
							<input type="password" id="actualpassword" class="focus:outline-none text-lg border dark:border-zinc-800 dark:bg-zinc-800 w-full py-2 px-2 rounded-md" placeholder={t("Password", locale)} required />
							<a href="/signin/password" rel="prefetch" class="text-sm text-gray-700 dark:text-white hover:text-gray-800 dark:hover:text-gray-200 w-1/2">{t("Forgot your password?", locale)}</a>
						</div>
						<div class="flex justify-end pt-2">
							<button onclick="close_modal()" class="focus:outline-none px-4 bg-none hover:underline duration-300 p-3 rounded-lg text-black hover:bg-gray-300 dark:text-white hover:dark:text-gray-200 hover:dark:bg-gray-800">{t("Cancel", locale)}</button>
							<button onclick="confirm()" class="focus:outline-none px-4 ml-3 rounded-lg text-white bg-green-500 hover:bg-green-700 transition-colors duration-300">{t("Save", locale)}</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</main>
</Layout>

<script lang="js">
    function close_modal() {
		document.getElementById("name_modal").classList.add("hidden");
        document.getElementById("email").value = "";
        document.getElementById("birthdate").value = "";
        document.getElementById("password").value = "";
	}
	function open_modal(part) {
		document.getElementById("uemail").classList.add("hidden");
        document.getElementById("ubirth").classList.add("hidden");
        document.getElementById("upass").classList.add("hidden");
        document.getElementById("emailshow").classList.add("hidden");
        document.getElementById("birthshow").classList.add("hidden");
        document.getElementById("newpassshow").classList.add("hidden");
        document.getElementById("passshow").classList.add("hidden");
        document.getElementById("password-tips").classList.add("hidden");
        document.getElementById("birth-tips").classList.add("hidden");

        if(part === "email") {
            document.getElementById("uemail").classList.remove("hidden");
            document.getElementById("emailshow").classList.remove("hidden");
            document.getElementById("passshow").classList.remove("hidden");
        } else if(part === "birth") {
            document.getElementById("ubirth").classList.remove("hidden");
            document.getElementById("birthshow").classList.remove("hidden");
            document.getElementById("birth-tips").classList.remove("hidden");
        } else if(part === "password") {
            document.getElementById("upass").classList.remove("hidden");
            document.getElementById("newpassshow").classList.remove("hidden");
            document.getElementById("passshow").classList.remove("hidden");
            document.getElementById("password-tips").classList.remove("hidden");
        }

		document.getElementById("name_modal").classList.remove("hidden");
	}
    function confirm() {
		document.getElementById("already_used_email").classList.add("hidden");
		document.getElementById("email").classList.add("dark:border-zinc-800");
		document.getElementById("email").classList.remove("border-red-500");
		document.getElementById("actualpassword").classList.add("dark:border-zinc-800");
		document.getElementById("actualpassword").classList.remove("border-red-500");
		document.getElementById("invalid_password").classList.add("hidden");

        fetch("https://oauth.gravitalia.com/users/@me", {
			method: "PATCH",
			headers: {
				"Authorization": `; ${document.cookie}`?.split(`; session=`)[1]?.split(";")[0],
				"Content-Type": "application/json"
			},
			body: JSON.stringify({
				password: document.getElementById("actualpassword").value||null,
                email: document.getElementById("email").value||null,
				birthdate: document.getElementById("birthdate").value||null,
				newpassword: document.getElementById("password").value||null
			})
		}).then(res => res.json())
		.then(res => {
			if(res.error && res?.message?.includes("suspended")) {
				document.cookie = "session=gv;expires=Thu, 01 Jan 1970 00:00:01 GMT;";
				window.location.reload();
			} else if(res.error) {
				if(res.message.toLowerCase().includes("email")) {
					document.getElementById("email").classList.remove("dark:border-zinc-800");
					document.getElementById("email").classList.add("border-red-500");
					document.getElementById("already_used_email").classList.remove("hidden");
				} else if(res.message === "Invalid password") {
					document.getElementById("actualpassword").classList.remove("dark:border-zinc-800");
					document.getElementById("actualpassword").classList.add("border-red-500");
					document.getElementById("invalid_password").classList.remove("hidden");
				}
            } else {
                window.location.reload();
            }
		});
    }
</script>