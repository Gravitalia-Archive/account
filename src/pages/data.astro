---
import Layout from "../layouts/Layout.astro";
import { t } from "../../Translator";
import Sidebar from "../components/Sidebar.astro";

const locale = `; ${Astro.request.headers.get("cookie")}`?.split(`; locale=`)[1]?.split(";")[0] ||
Astro.request.headers.get("accept-language")?.split(",")[0]?.split("-")[0] ||
"en";
const cookie = `; ${Astro.request.headers.get("cookie")}`?.split(`; session=`)[1]?.split(";")[0];
let user;
if(cookie) {
    user = await fetch("https://oauth.gravitalia.com/users/@me", {
		headers: {
			"Authorization": cookie
		}
	})
	.then(res => res.json())
	.catch(_ => null)
	.then(res => res);
	
	if(user?.message) return Astro.redirect("/signin", 307);
} else {
	return Astro.redirect("/signin", 307);
}
---

<Layout title="My Account - Gravitalia Account" absolute={null}>
    <p id="error" class="hidden w-full z-50 flex h-10 items-center justify-center bg-[#332b43] px-4 text-sm font-medium text-white sm:px-6 lg:px-8 absolute">
	    {t("An error occurred while deleting your account, or obtaining your data. Contact us via privacy@gravitalia.com", locale)}
	</p>

	<main class="min-h-screen w-full text-gray-700 dark:text-white">
		<header class="flex w-full items-center justify-between bg-white dark:bg-zinc-800 p-2">
			<div class="flex items-center space-x-2">
				<img src="/favicon.webp" class="h-8 w-8" />
				<h1 class="pl-2 text-xl font-bold">Gravitalia</h1>
			</div>

			<div class="relative pr-10 pt-2">
				<button aria-label="User menu" class="flex rounded-full text-sm focus:outline-none" onclick="document.getElementById('show-profile').classList.value.includes('hidden')?document.getElementById('show-profile').classList.remove('hidden'):document.getElementById('show-profile').classList.add('hidden')">
					<img src={user.avatar ? `https://cdn.gravitalia.com/${user.avatar}` : `https://www.gravitalia.com/avatar/${user.username[0].match(/[A-z]/) ? user.username[0].toUpperCase() : "A"}.webp`} class="h-8 w-8 rounded-full" alt="" />
				</button>

				<div class="pt-1">
					<div id="show-profile" class="hidden z-50 origin-top-right absolute right-5 mt-2 w-48 rounded-md shadow-lg py-1 bg-slate-100 dark:bg-slate-900 ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="vertical">
						<svg class="absolute bottom-full right-4" width="22" height="13" viewBox="0 0 30 20" xmlns="http://www.w3.org/2000/svg">
							<polygon class="fill-slate-100 dark:fill-slate-900" points="15, 0 30, 20 0, 20"/>
						</svg>
						<p class="block px-4 py-2 text-sm text-gray-800 dark:text-gray-100">{t("Signed in as", locale)}<br /><strong>{ user.username }</strong></p>
						<hr />
						<div class="grid grid-cols-3 px-6 py-3">
							<a href="https://www.gravitalia.com/" class="hover:bg-gray-200 w-10 h-10 rounded-full flex justify-center items-center"><img alt="Gravitalia" src="/favicon.webp" class="w-7 h-7" draggable="false" /></a>
						</div>
						<hr />
						<span class="block px-4 py-2 text-sm text-gray-700 dark:text-white cursor-pointer"><span onclick="document.cookie = 'session=gv;expires=Thu, 01 Jan 1970 00:00:01 GMT;',window.location.reload();">{t("Logout", locale)}</span></span>
					</div>
				</div>
			</div>
		</header>
	
		<div class="flex">
            <Sidebar />
            
            <div id="CF-Token-Generator" class="cf-turnstile" data-sitekey="0x4AAAAAAABG7Pcx4-fniaty" data-theme="auto" data-language={locale} data-callback="cf_callback"></div>
			<div class="w-full p-4">
				<p class="text-2xl font-semibold pb-4">{t("Delete account", locale)}</p>
				<div class="pt-4 pl-4 pr-4 border dark:border-none dark:bg-zinc-800 shadow-xs w-full lg:w-1/3 h-min lg:h-1/4 rounded-md">
                    <p class="text-sm">{t("Doing so will INSTANTLY and automatically delete ALL service data associated with your account. You will have the option of recovering your main account within 30 days.", locale)}</p>

                    <br /><br /><br />
                    <button onclick="open_modal()" class="my-4 text-sm mt-auto w-full py-2 bg-red-50 dark:bg-opacity-0 dark:border-none outline-none border border-red-100 rounded text-red-500 dark:text-white font-medium hover:bg-red-400 dark:hover:bg-red-500 hover:text-white transition-colors duration-200">
                        {t("Delete account", locale)}
                    </button>
				</div>
			</div>

			<div id="name_modal" class="hidden fixed w-full h-100 inset-0 z-50 overflow-hidden flex justify-center items-center" style="background: rgba(0,0,0,.7);">
				<div class="border-none shadow-lg bg-white dark:bg-zinc-900 w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
					<div class="py-4 text-left px-6">
						<div class="flex justify-between items-center">
							<p class="text-2xl font-bold">{t("Delete account", locale)}</p>
							<div class="cursor-pointer z-50" onclick="close_modal()">
								<svg class="fill-current text-black dark:text-white" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
									viewBox="0 0 18 18">
									<path
										d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z">
									</path>
								</svg>
							</div>
						</div>
                        <br />
						<p class="pb-3 text-sm text-gray-500 dark:text-gray-400">
                            {t("Deleting your account will affect all services.", locale)}
                            <br /><br />
                            {t("Doing so will INSTANTLY and automatically delete ALL service data associated with your account. You will have the option of recovering your main account within 30 days.", locale)}
                            <br /><br />
                            {t("All accounts of other services will be completely deleted (comments, publications...), and without delay. To proceed, type your password in the following entry.", locale)}
                        </p>
						<div class="my-5">
							<label for="password" class="text-sm w-full">{t("Password", locale)}</label>
							<input type="password" id="password" class="focus:outline-none text-lg border dark:border-zinc-800 dark:bg-zinc-800 w-full py-2 px-2 rounded-md" placeholder={t("Password", locale)} required />
						</div>
						<div class="flex justify-end pt-2">
							<button onclick="close_modal()" class="focus:outline-none px-4 bg-none hover:underline duration-300 p-3 rounded-lg text-black hover:bg-gray-300 dark:text-white hover:dark:text-gray-200 hover:dark:bg-gray-800">{t("Cancel", locale)}</button>
							<button onclick="confirm()" class="focus:outline-none px-4 ml-3 rounded-lg text-white bg-green-500 hover:bg-green-700 transition-colors duration-300">{t("Confirm", locale)}</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</main>
</Layout>

<script lang="js">
    let cf_token = "";

    function close_modal() {
		document.getElementById("name_modal").classList.add("hidden");
	}
	function open_modal() {
		document.getElementById("name_modal").classList.remove("hidden");
	}
    function confirm() {
		if(document.getElementById("password").value.length === 0) {
			document.getElementById("password").classList.remove("border-slate-500", "dark:border-zinc-800");
			document.getElementById("password").classList.add("border-red-500");
			return;
		} else {
			document.getElementById("password").classList.add("border-slate-500", "dark:border-zinc-800");
			document.getElementById("password").classList.remove("border-red-500");
		}

        fetch("https://oauth.gravitalia.com/users/@me", {
			method: "DELETE",
			headers: {
				"Authorization": `; ${document.cookie}`?.split(`; session=`)[1]?.split(";")[0],
				"Content-Type": "application/json"
			},
			body: JSON.stringify({
				password: document.getElementById("password").value,
                security_token: cf_token
			})
		}).then(res => res.json())
		.then(res => {
			if(res.error) {
				turnstile.reset();
                close_modal();
                document.getElementById("error").classList.remove("hidden");

                setTimeout(() => {
                    document.getElementById("error").classList.add("hidden");
                }, 1000*60);
            } else {
                document.cookie = 'session=gv;expires=Thu, 01 Jan 1970 00:00:01 GMT;'
                window.location.reload();
            }
		});
    }

    function cf_callback(token) {
		cf_token = token;
	}
</script>
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>